<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aprendendo com Lavine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            touch-action: none;
            overflow: hidden;
            background: linear-gradient(180deg, #E0C3FC 0%, #8EC5FC 100%);
        }
        
        .letter-slot {
            font-family: 'Fredoka One', cursive;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 4px 6px rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.6);
        }

        .letter-bubble {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            border: 4px solid white;
            touch-action: manipulation; 
            z-index: 20;
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translateX(-4px); }
            20%, 80% { transform: translateX(4px); }
            30%, 50%, 70% { transform: translateX(-8px); }
            40%, 60% { transform: translateX(8px); }
        }

        .pop-in {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .highlight-slot {
            border-color: #ec4899 !important;
            background-color: #fce7f3 !important;
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(236, 72, 153, 0.5);
            z-index: 10;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }
        
        .correct-hit {
            transition: transform 0.3s ease-out, opacity 0.3s ease-in;
            transform: scale(1.4) !important;
            opacity: 0 !important;
            background-color: #22c55e !important;
        }

        /* Estilo do Loading */
        #loadingOverlay {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 999;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center">

    <!-- Tela Inicial -->
    <div id="startScreen" class="absolute inset-0 z-50 bg-white/90 backdrop-blur-md flex flex-col items-center justify-center p-4 text-center">
        <div class="mb-8 animate-bounce text-6xl">üëßüèª</div>
        <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mb-2 font-['Fredoka_One']">
            Oi, <span class="text-pink-500">Lavine</span>!
        </h1>
        <p class="text-xl text-gray-500 mb-8 font-bold">Vamos aprender as letras?</p>
        
        <button onclick="startGame()" class="px-10 py-5 bg-pink-500 hover:bg-pink-600 text-white text-3xl rounded-full shadow-xl transition transform active:scale-95 font-bold flex items-center gap-3">
            <span>JOGAR</span> üîä
        </button>
    </div>

    <!-- √Årea do Jogo -->
    <div id="gameArea" class="w-full h-full flex flex-col hidden relative">
        
        <!-- Cabe√ßalho -->
        <div class="flex-none pt-8 pb-4 px-2 flex flex-col items-center z-30 bg-white/30 backdrop-blur-sm rounded-b-3xl shadow-sm mx-4 mt-2">
            <div class="flex items-center gap-2 mb-4 bg-white px-4 py-2 rounded-full shadow-sm">
                <span class="text-gray-500 font-bold">Procure o:</span>
                <!-- ADICIONADO ELEMENTO EMOJI -->
                <span id="target-emoji-display" class="text-3xl">üëßüèª</span>
                <span id="target-letter-display" class="text-4xl font-['Fredoka_One'] text-pink-600 font-bold animate-pulse">L</span>
            </div>
            
            <div id="slots-container" class="flex gap-2 md:gap-4 justify-center items-center flex-wrap px-2">
                <!-- Slots (agora din√¢micos) -->
            </div>
        </div>

        <!-- √Årea de Brincar -->
        <div id="play-area" class="flex-grow relative overflow-hidden touch-none">
            <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" class="w-full h-full fill-pink-400">
                    <path d="M44.7,-76.4C58.9,-69.2,71.8,-59.1,81.6,-46.6C91.4,-34.1,98.1,-19.2,95.8,-5.3C93.5,8.6,82.2,21.4,71.3,32.2C60.4,43,49.9,51.8,38.3,60.2C26.7,68.6,14,76.6,-0.4,77.3C-14.8,78,-31.2,71.4,-44.2,62C-57.2,52.6,-66.8,40.4,-73.6,26.9C-80.4,13.4,-84.4,-1.4,-80.4,-14.8C-76.4,-28.2,-64.4,-40.2,-51.8,-47.9C-39.2,-55.6,-26,-59,-12.8,-61.3C0.4,-63.6,13.6,-64.8,30.5,-83.6L44.7,-76.4Z" transform="translate(100 100)" />
                </svg>
            </div>
        </div>

        <!-- Tela de Vit√≥ria -->
        <div id="winScreen" class="hidden absolute inset-0 z-50 bg-black/40 backdrop-blur-sm flex flex-col items-center justify-center text-center p-4">
            <h2 class="text-6xl md:text-8xl mb-8 animate-bounce">üéâ</h2>
        <div class="bg-white p-8 rounded-3xl shadow-2xl">
            <div id="winEmojiDisplay" class="text-6xl mb-4">üéâ</div> <!-- MODIFICADO -->
            <p class="text-4xl font-['Fredoka_One'] text-pink-500 mb-2">PARAB√âNS!</p>
            <p id="winMessage" class="text-2xl text-gray-600 font-bold mb-6">Voc√™ escreveu LAVINE!</p>
            
            <!-- Bot√£o Gemini -->
                <button id="geminiButton" onclick="getNewWords()" class="w-full px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white text-2xl rounded-2xl shadow-lg active:scale-95 font-bold flex items-center justify-center gap-2 transition-all transform hover:scale-105">
                    ‚ú® Aprender palavra nova
                </button>
                
                <button onclick="resetGame(true)" class="w-full px-8 py-3 bg-gray-200 text-gray-700 text-lg rounded-2xl active:scale-95 font-bold mt-3 transition-all hover:bg-gray-300">
                    Jogar "LAVINE" de Novo
                </button>
            </div>
        </div>

        <!-- Tela de Loading -->
        <div id="loadingOverlay" class="hidden absolute inset-0 flex-col items-center justify-center text-white text-2xl font-bold">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-white mb-4"></div>
            <p id="loadingText">‚ú® Buscando uma palavra nova...</p>
        </div>
    </div>

    <script>
        const defaultName = ['L', 'A', 'V', 'I', 'N', 'E'];
        let targetName = [...defaultName]; // Agora √© din√¢mico
        let currentEmoji = 'üëßüèª'; // Emoji atual (come√ßa com Lavine)

        const colors = [
            'bg-pink-500', 'bg-purple-500', 'bg-indigo-500', 
            'bg-blue-500', 'bg-teal-500', 'bg-green-500'
        ];
        
        let currentStep = 0;
        let synth = window.speechSynthesis;
        let audioCtx;

        // --- SISTEMA DE √ÅUDIO ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSuccessSound() {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function playErrorSound() {
            if (!audioCtx) initAudio();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }

        function speak(text, delay = 0) {
            setTimeout(() => {
                try {
                    if (synth.speaking) synth.cancel();
                    const utterThis = new SpeechSynthesisUtterance(text);
                    utterThis.lang = 'pt-BR';
                    utterThis.rate = 1.0;
                    utterThis.pitch = 1.2;
                    synth.speak(utterThis);
                } catch (e) { console.error(e); }
            }, delay);
        }

        // --- L√ìGICA DO JOGO ---

        function startGame() {
            initAudio();
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            setTimeout(() => {
                resetGame(true); // Come√ßa com o nome padr√£o
                speak("Onde est√° a letra L?");
            }, 200);
        }

        function resetGame(useDefaultName = false) {
            if (useDefaultName) {
                targetName = [...defaultName];
                currentEmoji = 'üëßüèª';
            }
            
            currentStep = 0;
            document.getElementById('winScreen').classList.add('hidden');
            
            const slotsContainer = document.getElementById('slots-container');
            const playArea = document.getElementById('play-area');
            
            slotsContainer.innerHTML = '';
            const bubbles = playArea.querySelectorAll('.letter-bubble');
            bubbles.forEach(b => b.remove());

            // Criar Slots dinamicamente
            targetName.forEach((char, index) => {
                const slot = document.createElement('div');
                slot.id = `slot-${index}`;
                // Tamanhos responsivos
                slot.className = `letter-slot w-11 h-14 md:w-16 md:h-20 border-4 border-dashed border-gray-400 rounded-xl flex items-center justify-center text-3xl md:text-5xl text-gray-400`;
                slotsContainer.appendChild(slot);
            });

            // --- L√ìGICA DE POSICIONAMENTO ANTI-SOBREPOSI√á√ÉO ---
            const placedRects = [];
            const elSize = window.innerWidth < 640 ? 65 : 100;
            const containerRect = playArea.getBoundingClientRect();
            const margin = 10;
            const maxX = containerRect.width - elSize - margin;
            const maxY = containerRect.height - elSize - margin;

            // Criar Letras dinamicamente
            let lettersData = targetName.map((char, i) => ({ 
                char, 
                color: colors[i % colors.length] // Usa m√≥dulo para n√£o estourar array de cores
            }));
            lettersData.sort(() => Math.random() - 0.5);

            lettersData.forEach((item) => {
                
                // Encontra uma posi√ß√£o que n√£o sobreponha
                let newRect;
                let isOverlapping = true;
                let attempts = 0;

                while (isOverlapping && attempts < 50) { // Tenta 50x
                    attempts++;
                    const x = Math.floor(Math.random() * (maxX > 0 ? maxX : 1)) + margin/2;
                    const y = Math.floor(Math.random() * (maxY > 0 ? maxY : 1)) + margin/2;
                    
                    newRect = { x, y, width: elSize, height: elSize };
                    
                    isOverlapping = false; // Assume que est√° bom
                    for (const rect of placedRects) {
                        if (isOverlappingRects(newRect, rect, 10)) { // 10px de padding
                            isOverlapping = true;
                            break;
                        }
                    }
                }
                placedRects.push(newRect);

                const bubble = document.createElement('div');
                bubble.textContent = item.char;
                bubble.className = `letter-bubble floating ${item.color}`;
                
                bubble.style.width = `${elSize}px`;
                bubble.style.height = `${elSize}px`;
                bubble.style.fontSize = window.innerWidth < 640 ? '2.5rem' : '4rem';
                
                // Aplica a posi√ß√£o encontrada
                bubble.style.left = `${newRect.x}px`;
                bubble.style.top = `${newRect.y}px`;
                bubble.style.animationDelay = `-${Math.random() * 5}s`;

                bubble.onclick = (e) => handleInput(item.char, bubble, item.color, e);
                
                playArea.appendChild(bubble);
                // REMOVIDO: setRandomPosition(bubble, playArea);
            });

            updateGameState();
        }

        // Nova fun√ß√£o para checar sobreposi√ß√£o de ret√¢ngulos (com padding)
        function isOverlappingRects(rect1, rect2, padding = 0) {
            return (
                rect1.x < rect2.x + rect2.width + padding &&
                rect1.x + rect1.width + padding > rect2.x &&
                rect1.y < rect2.y + rect2.height + padding &&
                rect1.y + rect1.height + padding > rect2.y
            );
        }

        /* REMOVIDA: function setRandomPosition(element, container) { ... } */

        function updateGameState() {
            document.querySelectorAll('.letter-slot').forEach((el, idx) => {
                el.classList.remove('highlight-slot', 'border-pink-500');
                if (idx === currentStep) {
                    el.classList.add('highlight-slot', 'border-pink-500');
                    el.classList.remove('border-dashed');
                    el.classList.add('border-solid');
                }
            });

            // Atualiza o emoji e a letra
            document.getElementById('target-emoji-display').textContent = currentEmoji;
            if (currentStep < targetName.length) {
                const letter = targetName[currentStep];
                document.getElementById('target-letter-display').innerText = letter;
            }
        }

        function handleInput(char, element, colorClass, event) {
            if(event) event.stopPropagation();

            const expectedChar = targetName[currentStep];

            if (char === expectedChar) {
                // --- ACERTOU ---
                speak(char);
                setTimeout(() => playSuccessSound(), 300);

                element.classList.remove('floating');
                void element.offsetWidth; 
                element.classList.add('correct-hit');

                const slot = document.getElementById(`slot-${currentStep}`);
                slot.textContent = char;
                slot.className = `letter-slot w-11 h-14 md:w-16 md:h-20 border-4 border-white rounded-xl flex items-center justify-center text-3xl md:text-5xl text-white shadow-lg pop-in ${colorClass}`;

                const rect = slot.getBoundingClientRect();
                confetti({
                    particleCount: 30,
                    spread: 50,
                    origin: { 
                        x: (rect.left + rect.width/2) / window.innerWidth, 
                        y: (rect.top + rect.height/2) / window.innerHeight
                    },
                    colors: ['#ffffff', '#fdf2f8']
                });

                setTimeout(() => {
                    if(element.parentNode) element.parentNode.removeChild(element);
                }, 350);

                currentStep++;

                if (currentStep === targetName.length) {
                    setTimeout(winGame, 800);
                } else {
                    updateGameState();
                }

            } else {
                // --- ERROU ---
                if (navigator.vibrate) navigator.vibrate(50);
                
                speak(char);
                setTimeout(() => playErrorSound(), 400);

                element.classList.remove('shake');
                void element.offsetWidth; 
                element.classList.add('shake');
                
                element.style.borderColor = '#ef4444'; 
                setTimeout(() => {
                    element.style.borderColor = 'white';
                }, 500);
            }
        }

        function winGame() {
            const word = targetName.join('');
            speak(`Muito bem! Voc√™ escreveu ${word}!`);
            playSuccessSound();
            
            document.getElementById('winEmojiDisplay').textContent = currentEmoji; // Mostra emoji na vit√≥ria
            document.getElementById('winMessage').textContent = `Voc√™ escreveu ${word}!`;
            document.getElementById('winScreen').classList.remove('hidden');
            
            // Confete final
            const duration = 3000;
            const end = Date.now() + duration;
            (function frame() {
                confetti({
                    particleCount: 4, angle: 60, spread: 55, origin: { x: 0 },
                    colors: ['#ec4899', '#a855f7', '#ffffff']
                });
                confetti({
                    particleCount: 4, angle: 120, spread: 55, origin: { x: 1 },
                    colors: ['#ec4899', '#a855f7', '#ffffff']
                });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        window.addEventListener('resize', () => {
            const bubbles = document.querySelectorAll('.letter-bubble');
            const playArea = document.getElementById('play-area');
            if(playArea && !document.getElementById('gameArea').classList.contains('hidden')) {
                 bubbles.forEach(b => setRandomPosition(b, playArea));
            }
        });

        // --- INTEGRA√á√ÉO GEMINI API ---

        function showLoading(isLoading, message = "‚ú® Buscando uma palavra nova...") {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = message;
            if (isLoading) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            } else {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        // Fun√ß√£o de backoff exponencial para chamadas de API
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        // Throttling, espera e tenta de novo
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`Erro na API: ${response.statusText}`);
                }
                return response.json();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }

        async function getNewWords() {
            showLoading(true);
            
            const apiKey = ""; // Deixe em branco, ser√° fornecido pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Prompt para a IA (agora pede emoji)
            const prompt = "Gere 3 objetos em portugu√™s, simples, de 3 a 5 letras, para uma crian√ßa de 3 anos. Para CADA objeto, forne√ßa a palavra (ex: BOLA, GATO, SOL) e um √∫nico emoji que o represente (ex: ‚öΩ, üêà, ‚òÄÔ∏è). Use apenas letras mai√∫sculas. Evite acentos e √á.";

            // Schema para garantir a resposta em JSON (agora pede emoji)
            const schema = {
                type: "OBJECT",
                properties: {
                    "objetos": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "palavra": { "type": "STRING" },
                                "emoji": { "type": "STRING" }
                            },
                            required: ["palavra", "emoji"]
                        }
                    }
                },
                required: ["objetos"]
            };

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 1.0, // Criativo
                }
            };

            try {
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const { objetos } = JSON.parse(jsonText);
                    
                    // Pega um item aleat√≥rio (palavra + emoji) da lista
                    const randomItem = objetos[Math.floor(Math.random() * objetos.length)];
                    const newWord = randomItem.palavra.toUpperCase();
                    const newEmoji = randomItem.emoji;
                    
                    // Define a nova palavra e emoji
                    targetName = newWord.split('');
                    currentEmoji = newEmoji;
                    
                    resetGame(false); // false = n√£o usar "LAVINE"
                    
                    showLoading(false);
                    // MODIFICADO: Falar a palavra inteira, e n√£o mais soletrar
                    speak(`Vamos aprender a palavra ${newWord}`);

                } else {
                    throw new Error("Resposta da API inv√°lida.");
                }

            } catch (error) {
                console.error("Erro ao chamar Gemini API:", error);
                showLoading(true, "Oops! Erro. Tente de novo.");
                // Esconde a mensagem de erro depois de 2s
                setTimeout(() => showLoading(false), 2000);
            }
        }
    </script>
</body>
</html>
